# 방송 추천 워크플로우 & 로그 설명

## 1. 전체 개요

- **목적**
  - 특정 방송 시간(`broadcastTime`)에 대해 **트렌드 + 매출 예측 + 경쟁사 편성**을 모두 고려한 방송 상품 추천을 생성한다.
- **주요 구성 요소**
  - 컨텍스트 & 트렌드 수집 (LLM 기반)
  - 통합 검색 (Qdrant 벡터 검색)
  - XGBoost 매출 예측
  - 최종 랭킹 및 LLM 추천 근거 생성
  - 네이버 베스트 상품 / 타사 편성 정보 포함

---

## 2. 단계별 파이프라인 & 주요 로그

### 2.1 API 진입 (`/api/v1/broadcast/recommendations`)

- **관련 코드**: `backend/app/main.py`
- **예시 로그**
  ```text
  --- API Endpoint /api/v1/broadcast/recommendations received a request: 2025-11-18T10:40:00+09:00 ---
  --- 가중치 설정: 트렌드 30% / 매출 70% ---
  ...
  ⏱️  총 응답 시간: 33.34초
  ```
- **의미**
  - 어떤 시간대에 추천을 요청했는지 (broadcastTime)
  - 트렌드/매출 가중치 설정
  - 전체 API 응답 시간(엔드투엔드 latency)

---

### 2.2 1단계: 컨텍스트 & 기본 트렌드 키워드 수집

- **관련 코드**: `BroadcastWorkflow._collect_context_and_keywords`
- **주요 로그**
  ```text
  === [DEBUG] _collect_context_and_keywords 호출 ===
  ⏱️  [1단계] 컨텍스트 수집: 22.04초
  [LLM 프롬프트] 트렌드 키워드 생성 - AI Trend API
  시간대: 오전 시간대 (09:00-12:00), 날씨: Clear, 기온: 5.0°C
  ...
  [1단계 - 응답] LLM 생성 키워드: ['가을패션', '점퍼', '가벼운외투', ...]
  [1단계 - 결과] 총 9개 키워드
  ```
- **의미**
  - 방송 시간, 요일, 계절, 날씨 등으로 **현재 상황 컨텍스트**를 생성한다.
  - LLM에게 “이 시간대에 잘 팔릴 만한 상품 키워드”를 생성하도록 요청하고, 결과를 키워드 리스트로 사용한다.

---

### 2.3 2단계: 실시간 웹 트렌드 수집

- **관련 코드**: `BroadcastWorkflow._collect_context_and_keywords` 내 2단계 Web Search 부분
- **주요 로그**
  ```text
  [2단계 - OpenAI Web Search] 실시간 트렌드 수집 시작
  [프롬프트] ... 반드시 JSON 배열로만 반환: ["키워드1", "키워드2", ...]
  ...
  [2단계 - 응답] 현재 한국에서 인기 있는 쇼핑 관련 키워드를 조사한 결과, ...
  [2단계 - 실패] JSON 배열을 찾을 수 없음
  [통합 키워드] 최종 9개: ['가을패션', '점퍼', ...]
  ```
- **의미**
  - LLM + Web Search로 **실제 시점의 쇼핑 트렌드 키워드**를 가져오려 한다.
  - 응답이 JSON 배열 형식을 지키지 않으면:
    - `[2단계 - 실패] JSON 배열을 찾을 수 없음` 로그를 남긴다.
    - 2단계 결과는 버리고, **1단계에서 만든 키워드만으로 안전하게 계속 진행**한다.
  - 이 로그는 **서비스 오류가 아니라, 실시간 웹 트렌드 반영이 이번 호출에서는 빠졌다는 정보**에 가깝다.

---

### 2.4 3단계: 통합 검색 (Qdrant + 카테고리)

- **관련 코드**: `BroadcastWorkflow._execute_unified_search`
- **주요 로그**
  ```text
  === [DEBUG Multi-Stage Search] 시작, keywords: 59개 ===
  === [개별 키워드 검색] 총 59개 키워드 ===
  === [DEBUG Unified Search] 검색 결과: 50개 상품 ===
  === [DEBUG Unified Search] 직접매칭: 0개, 카테고리: 8개 ===
  ```
- **의미**
  - 통합된 키워드들을 Qdrant 벡터 DB에 넘겨 **유사 상품 후보를 검색**한다.
  - 직접 키워드 매칭 여부와, 카테고리 기반으로 확보한 후보 수를 확인할 수 있다.

#### [미적용] 방송 기간 필터링 (TODO)

> **현재 주석 처리됨** - 요구사항 확정 후 활성화 예정

- **목적**: 입력된 방송 시간 기준 앞뒤 1개월 기간을 과거 5년간 조회하여, 해당 시기에 방송된 상품만 후보군으로 제한
- **관련 메서드**:
  - `_get_historical_broadcast_periods()`: 과거 연도별 동일 시기 기간 생성
  - `ProductEmbedder.get_products_by_multiple_periods()`: PostgreSQL에서 해당 기간 방송 상품 조회
  - `ProductEmbedder.search_products_with_broadcast_filter()`: 기간 필터 + 벡터 검색 통합
- **예상 로그** (활성화 시):
  ```text
  === [방송 기간 필터] 기준일: 2025-03-15, 5개 기간 ===
    - 2024-02-15 ~ 2024-04-15
    - 2023-02-15 ~ 2023-04-15
    - 2022-02-15 ~ 2022-04-15
  === [다중 기간 필터] 5개 기간 → 방송 상품: 441개 ===
  ```

---

### 2.5 4단계: XGBoost 매출 예측 & 후보 스코어링

- **관련 코드**: `BroadcastWorkflow._generate_unified_candidates`, `_prepare_features_for_product`
- **주요 로그**
  ```text
  === [DEBUG] 배치 예측 대상: 30개 ===
  [배치 예측] 완료
    평균: 1561만원 / 최소: 1137만원 / 최대: 1799만원 / 표준편차: 125만원
  [예측 결과 샘플]
    1. 종근당건강 프리바이오틱스 10개월 → 1642만원
    ...
  [저유사도] 비에날씬 다이어트 유산균 9박스: 유사도=0.43, 매출=1718만원, 점수=0.249
  ...
  === [DEBUG _rank_final_candidates] 이미 점수순으로 정렬된 30개 후보 수신 ===
    1위: 종근당건강 프리바이오틱스 10개월 (점수: 0.266, 타입: sales_prediction)
    2위: 쿠쿠 10인용 밥솥 CRP-QS107FG/FS (점수: 0.261, 타입: sales_prediction)
  ```
- **의미**
  - 후보 상품들에 대해 **XGBoost 매출 예측 모델**로 예상 매출을 계산한다.
  - 유사도와 매출을 가중합하여 최종 점수를 만든 뒤, 점수 순으로 최종 Top N을 선정한다.
  - 로그를 통해 예측 분포(평균, 최소, 최대, 표준편차)와 대표 상품들의 예측 값을 한 눈에 확인할 수 있다.

---

### 2.6 5-1단계: LLM 배치 추천 근거 생성

- **관련 코드**: `BroadcastWorkflow._generate_batch_reasons_with_langchain`
- **주요 로그**
  ```text
  [5-1단계] LLM 배치 처리 - 10개 상품의 추천 근거 생성
  ✅ 배치 처리 완료: 10개 근거 생성
  ⏱️  [5-1단계] 추천 근거 생성: 9.37초
  ```
- **의미**
  - **성능 최적화**: 10개 상품의 추천 근거를 한 번의 LLM 호출로 배치 생성
  - 이전에는 상품당 1번씩 총 10번 호출했으나, 이제는 1번만 호출하여 속도 50% 이상 개선
  - 각 상품마다 독창적이고 구체적인 근거 문장 생성 (100자 이내)
  - 실제 응답의 `reasoning` 필드에 이 결과가 들어간다 (단순 문자열로 변경)

---

### 2.7 5-2단계: 네이버/타사 편성 조회 및 AI 선택

- **관련 코드**: `BroadcastWorkflow._select_and_merge_top_10`
- **주요 로그**
  ```text
  [5-2단계] 네이버/타사 편성 조회 및 AI 선택
  ✅ 네이버 상품 10개 수집
  ✅ 타사 편성 20개 수집
  ⏱️  [5-2단계] 네이버/타사 선택: 6.17초
  ```
- **의미**
  - 네이버 쇼핑 인기 상품 10개 조회 (PostgreSQL)
  - 해당 시간대 ±1-2시간 내 타사 편성 조회 (Netezza)
  - AI가 네이버+타사 중 10개를 선택 (5:5 비율 유지 목표)
  - 또 다른 LLM 호출로 시간 소요
  - 응답의 `competitorProducts` 필드에 통합 결과 포함

---

### 2.8 6단계: 추천 결과 요약 로그 (`[RECOMMENDATION] ...`)

- **관련 코드**: `BroadcastWorkflow._format_response`
- **추가된 로그 (print)**
  ```python
  print(
      f"[RECOMMENDATION] #{recommendation.rank} "
      f"{recommendation.productInfo.productName} | "
      f"카테고리: {recommendation.productInfo.category} | "
      f"예측매출: {recommendation.businessMetrics.aiPredictedSales} | "
      f"최종점수: {candidate.get('final_score', 0.0):.3f} | "
      f"근거: {recommendation.reasoning.summary}"
  )
  ```
- **예상 로그 예시**
  ```text
  [RECOMMENDATION] #1 비에날씬 다이어트 유산균 9박스 | 카테고리: 건강식품 | 예측매출: 1,718.0만원 | 최종점수: 0.249 | 근거: (LLM이 생성한 한 줄 요약)
  ```
- **의미**
  - 각 추천 결과를 한 줄로 요약해서 **시연/분석용으로 보기 쉽게 출력**한다.
  - 프런트엔드가 없어도, 로그만으로 “지금 이 시간에 어떤 상품이 몇 위로 추천되었는지 / 왜 추천됐는지”를 설명할 수 있다.

---

### 2.9 전체 시간 측정 요약

- **주요 로그**
  ```text
  ⏱️  [1단계] 컨텍스트 수집: 7.17초
  ⏱️  [2단계] 통합 검색: 0.35초
  ⏱️  [3단계] 후보군 생성: 0.01초
  ⏱️  [4단계] 최종 랭킹: 0.00초
  ⏱️  [5-1단계] 추천 근거 생성: 9.37초
  ⏱️  [5-2단계] 네이버/타사 선택: 6.17초
  ⏱️  [5단계] 응답 생성 총: 15.96초
  ⏱️  ===== 워크플로우 총 시간: 29.74초 =====
  ```
- **의미**
  - 각 단계별 소요 시간을 측정하여 성능 병목 지점 파악
  - 5단계(응답 생성)가 전체의 약 52%를 차지
  - 그 중 5-1단계(LLM 배치 근거 생성)가 9.37초로 가장 오래 걸림
  - 5-2단계(네이버/타사 AI 선택)도 6.17초 소요
  - 두 단계 모두 LLM API 호출이 주요 원인

---

## 3. "JSON 배열을 찾을 수 없음" 로그의 의미

- 예시 로그:
  ```text
  [2단계] 실시간 트렌드에서 JSON 배열을 찾을 수 없음
  ```

- **상황 설명**
  - 2단계 Web Search에서 LLM에게 "JSON 배열 형식으로만 응답하라"고 지시하지만,
    실제 응답이 서술형 문장이나 bullet 리스트로 돌아올 수 있다.
  - 이 때 파서가 JSON 배열을 찾지 못하면 이 로그가 남는다.

- **영향**
  - 2단계에서 얻은 실시간 트렌드 키워드는 사용하지 않는다.
  - 1단계에서 만든 기본 컨텍스트 키워드만 가지고도 추천 파이프라인은 **정상 동작**한다.
  - 따라서 이 로그는 **치명적인 에러가 아니라, "이번 호출에서는 실시간 웹 트렌드 반영을 생략했다"는 정보**이다.

---

## 4. 정리: 이 로그들로 무엇을 설명할 수 있는가?

- **데이터 흐름**
  - 컨텍스트(시간/날씨/계절/요일) → 트렌드 키워드 → Qdrant 검색 → XGBoost 매출 예측 → LLM 추천 근거 → 경쟁사/네이버 정보 결합.
- **설명 가능성(Explainability)**
  - 각 단계의 입력/출력과 중간 지표(예측 매출, 유사도, 최종 점수)가 로그에 드러난다.
  - LLM 프롬프트와 결과도 함께 남기므로, "왜 이런 문장으로 설명되었는지"를 추적 가능하다.
- **시연/데모 용도**
  - `[RECOMMENDATION]` 한 줄 요약 로그와 LLM 프롬프트 로그만 보여줘도
    - 어떤 상품이 추천되었고
    - 어떤 데이터와 컨텍스트를 기반으로 추천되었으며
    - 왜 그런 문장으로 설명되었는지를
    쉽게 설명할 수 있다.
