# 추천 다양성 튜닝 가이드

> 2024-12-22 업데이트

---

## 1. 개요

추천 시스템의 다양성을 높이기 위해 다음 기능들이 구현되었습니다:

- **복합 출처 시스템**: 여러 출처에서 추천된 상품에 가산점 부여
- **출처별 최소 쿼터**: 각 출처별로 최소 N개 보장
- **상세 추천 근거**: 각 출처별 상세 정보 표시

---

## 2. 추천 출처 (Track)

| Track | 출처명 | 설명 | 가산점 |
|-------|--------|------|--------|
| A | 뉴스/AI | 트렌드 키워드 RAG 검색 | 뉴스: +0.08, AI: 0 |
| B | 매출상위 | XGBoost 매출 예측 상위 | +0.12 |
| C | 과거실적 | 유사 시간대 과거 방송 실적 | +0.10 |
| D | 경쟁사 | 경쟁사 편성 기반 RAG 검색 | +0.15 |

### 2.1 복합 출처 가산점

여러 출처에서 동시에 추천된 상품은 추가 가산점을 받습니다:

```
복합 가산점 = 0.05 × (출처 개수 - 1)
```

| 출처 개수 | 추가 가산점 | 예시 |
|-----------|-------------|------|
| 1개 | 0 | `[경쟁사]` |
| 2개 | +0.05 | `[경쟁사|AI분석]` |
| 3개 | +0.10 | `[경쟁사|매출상위|AI분석]` |

---

## 3. 점수 계산 공식

```
기본점수 = 유사도 × 0.2 + (예측매출 / 1억) × 0.8

Track별 가산점:
  - 경쟁사: +0.15
  - 매출상위: +0.12
  - 과거실적: +0.10
  - 뉴스 (유사도 ≥ 0.50): +0.08
  - AI분석 (유사도 < 0.50): 0
  - 출처 없음: -0.05 (패널티)

복합 가산점 = 0.05 × (출처 개수 - 1)

최종점수 = 기본점수 + Track별 가산점 합계 + 복합 가산점
```

---

## 4. 출처별 최소 쿼터

각 출처별로 최소 개수를 보장합니다:

| 출처 | 최소 쿼터 |
|------|----------|
| 경쟁사 | 2개 |
| 매출상위 | 2개 |
| 과거실적 | 2개 |
| 뉴스 | 2개 |

**동작 방식:**
1. 점수순으로 정렬된 후보군에서 각 출처별로 쿼터만큼 우선 선택
2. 나머지는 점수순으로 채움
3. 다시 점수순 정렬

**주의:** 해당 출처의 상품이 쿼터보다 적으면 있는 만큼만 선택됩니다.

---

## 5. 추천 근거 형식

### 5.1 출처 태그

```
[경쟁사|뉴스]  ← 복합 출처
[매출상위|AI분석]
[과거실적]  ← 단일 출처
```

### 5.2 경쟁사 상세 정보

```
[경쟁사대응] {방송사} '{편성제목}' ({시간}) 키워드:'{매칭키워드}'
```

**예시:**
```
[경쟁사대응] hmallplus '에이앤디 사가폭스 밍크카라 패딩코트' (08:00) 키워드:'사가폭스'
[경쟁사대응] ssgshop '[런칭가299,000원→10만원 인하] 엘라코닉 캐시' (08:31) 키워드:'코트'
```

### 5.3 과거실적 상세 정보

```
[과거실적] 최근 {방송일자} {시간} 방송 매출 {매출} (평균 {평균매출}, {방송횟수}회)
```

**예시:**
```
[과거실적] 최근 2024-11-11 09:31 방송 매출 2,729만원 (평균 2,729만원, 1회)
[과거실적] 최근 2025-12-19 08:32 방송 매출 2,554만원 (평균 2,946만원, 7회)
```

### 5.4 뉴스 트렌드 정보

```
[뉴스] '{키워드}' 트렌드 (출처: {URL}...)
```

**예시:**
```
[뉴스] '유로컬렉션 밍크 재킷' 트렌드 (출처: https://news.bizwatch.co.kr/article/consumer/2025/...)
```

### 5.5 AI 트렌드 정보

```
[AI] '{키워드}' 시즌 트렌드
```

**예시:**
```
[AI] '유산균' 시즌 트렌드
[AI] '전기장판' 시즌 트렌드
```

---

## 6. 경쟁사 키워드 필터링

경쟁사 편성 제목에서 키워드 추출 시 의미없는 단어를 제외합니다:

### 6.1 제외되는 키워드

**시즌 코드:**
```
24FW, 25FW, 24SS, 25SS, 23FW, 23SS, 22FW, 22SS, FW, SS, AW
```

**프로모션 관련:**
```
특가, 특가전, 대전, 기획전, 세일, 할인, 프리미엄, 스페셜, 단독, 한정, 베스트, 인기, 추천
```

**수량/단위:**
```
개월, 개월분, 박스, 세트, 팩, 통, 개, 매
```

**방송 관련:**
```
방송, 홈쇼핑, 라이브, 생방송, 앵콜, 재방송
```

**기타:**
```
신규, 런칭, 오픈, 리뉴얼, 업그레이드, 뉴, NEW, 총, 전, 종, 구성
```

---

## 7. 시간 범위 설정

### 7.1 경쟁사 편성 조회

- **범위**: 방송 시간 ±1시간
- **예시**: 15:00 방송 → 14:00~16:00 경쟁사 편성 조회

### 7.2 과거 실적 조회

- **월 범위**: ±1개월 (예: 12월 → 11월~1월)
- **시간 범위**: ±1시간 (예: 9시 → 8시~10시)

---

## 8. 테스트 결과 예시

```
=== 출처별 통계 ===
경쟁사: 5개, 매출상위: 4개, 과거실적: 1개
뉴스: 3개, AI분석: 5개, 복합: 8개
```

**추천 목록:**
```
 1위 | [경쟁사|뉴스] | 라쉬반 엠비션 드로즈 컬렉션
 2위 | [경쟁사|뉴스] | 발레리 올레이스 지퍼 브라 컬렉션
 3위 | [경쟁사|뉴스] | 크로커다일 감탄브라 감탄핏 컬렉션
 4위 | [경쟁사|AI분석] | 24FW 마담엘레강스 샹제리 리버시블 코트
 5위 | [매출상위|AI분석] | [세일] 벨기에 유산균+다이어트 12박스
 6위 | [매출상위|AI분석] | 에버홈 생선구이기 점보 EV-RG3000B
 7위 | [매출상위|AI분석] | 도깨비방망이 PHB2200
 8위 | [매출상위|AI분석] | 조혜련 생생착즙기
 9위 | [경쟁사] | [골드피아]24K순금 럭키 테일 목걸이
10위 | [과거실적] | [단독구성]동국제약 마데카크림 + 리프팅 앰플
```

---

## 9. 관련 파일

| 파일 | 설명 |
|------|------|
| `backend/app/broadcast_workflow.py` | 추천 워크플로우 메인 로직 |
| `backend/app/product_embedder.py` | 상품 검색 및 과거 실적 조회 |
| `backend/app/netezza_config.py` | 경쟁사 편성 조회 |

---

## 10. 변경 이력

| 날짜 | 변경 내용 |
|------|----------|
| 2024-12-22 | 복합 출처 가산점 추가 |
| 2024-12-22 | 경쟁사 추천 근거 상세화 (방송사, 제목, 시간, 키워드) |
| 2024-12-22 | 과거실적 추천 근거 상세화 (최근 방송일자, 매출) |
| 2024-12-22 | 경쟁사 키워드 필터링 (시즌 코드 등 제외) |
| 2024-12-22 | [컨텍스트] 표시 삭제 |
| 2024-12-22 | 뉴스 기준 유사도 0.70 → 0.50 조정 |
| 2024-12-22 | 출처별 최소 쿼터 source_labels 기반으로 변경 |
